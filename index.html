<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Solicita√ß√£o de Servi√ßos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="container max-w-2xl">
        <div id="appContent" class="fade-in">
            <div class="bg-white card p-6 md:p-8 mb-6 rounded-2xl shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                    <div class="flex items-center gap-4 mb-4 md:mb-0">
                        <!-- LOGO: coloque o arquivo do logo na mesma pasta e nomeie como logo.jpg
                             Caso queira usar o nome original do upload, renomeie-o para logo.jpg
                        -->
                        <img id="systemLogo" src="logo.jpg" alt="Logo do Sistema" class="w-20 h-20 object-contain rounded-lg shadow-sm" onerror="this.style.display='none'">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Solicita√ß√£o de Servi√ßo</h1>
                            <p class="text-gray-600">Preencha o formul√°rio abaixo para solicitar nosso servi√ßo ou produto</p>
                        </div>
                    </div>
                </div>

                <form id="serviceForm" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2" for="name">Nome Completo</label>
                        <input id="name" name="name" type="text" required class="form-input w-full px-4 py-3 border rounded-xl border-gray-300">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2" for="email">E-mail</label>
                        <input id="email" name="email" type="email" required class="form-input w-full px-4 py-3 border rounded-xl border-gray-300">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2" for="phone">Telefone</label>
                        <input id="phone" name="phone" type="tel" required class="form-input w-full px-4 py-3 border rounded-xl border-gray-300">
                    </div>

                    <!-- Tipo de Servi√ßo agora √© um input de texto com sugest√µes (datalist) -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2" for="serviceType">Tipo de Servi√ßo</label>
                        <input id="serviceType" name="serviceType" list="serviceSuggestions" placeholder="Descreva o tipo de servi√ßo..." required
                               class="form-input w-full px-4 py-3 border rounded-xl border-gray-300">
                        <datalist id="serviceSuggestions">
                            <option value="Consultoria"></option>
                            <option value="Desenvolvimento Web"></option>
                            <option value="Design Gr√°fico"></option>
                            <option value="Marketing Digital"></option>
                            <option value="Higieniza√ß√£o de Estofados"></option>
                            <option value="Limpeza de Colch√µes"></option>
                        </datalist>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2" for="description">Descri√ß√£o do Servi√ßo</label>
                        <textarea id="description" name="description" rows="4" required class="form-input w-full px-4 py-3 border rounded-xl border-gray-300"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Urg√™ncia</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="urgency" value="Baixa" required>
                                <span class="ml-2">Baixa</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="urgency" value="M√©dia">
                                <span class="ml-2">M√©dia</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="urgency" value="Alta">
                                <span class="ml-2">Alta</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2" for="budget">Or√ßamento Previsto (R$)</label>
                        <input id="budget" name="budget" type="number" min="0" step="0.01" class="form-input w-full px-4 py-3 border rounded-xl border-gray-300">
                    </div>

                    <!-- Upload de evid√™ncias com pr√©-visualiza√ß√£o -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2" for="evidence">Evid√™ncias (fotos) ‚Äî opcional</label>
                        <input id="evidence" name="evidence" type="file" accept="image/*" multiple class="mb-3">
                        <div id="preview" class="grid grid-cols-3 gap-3"></div>
                    </div>

                    <div class="flex items-center">
                        <input id="terms" name="terms" type="checkbox" required class="form-checkbox h-5 w-5 text-blue-600">
                        <label for="terms" class="ml-2 text-gray-700">Aceito os termos e condi√ß√µes</label>
                    </div>

                    <button type="submit" class="bg-blue-600 hover:bg-blue-800 w-full text-white font-bold py-3 px-4 rounded-full flex items-center justify-center">
                        <i class="fas fa-paper-plane mr-2"></i> Enviar Solicita√ß√£o
                    </button>
                </form>
            </div>
        </div>
    </div>

<script>
    const serviceForm = document.getElementById('serviceForm');
    const evidenceInput = document.getElementById('evidence');
    const preview = document.getElementById('preview');

    // Armazena dataURLs das imagens selecionadas
    let evidenceDataURLs = [];

    // Pr√©-visualiza√ß√£o das imagens
    evidenceInput.addEventListener('change', async (e) => {
        preview.innerHTML = '';
        evidenceDataURLs = [];
        const files = Array.from(e.target.files).slice(0, 12); // limite pr√°tico: 12 imagens
        for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            const dataUrl = await fileToDataURL(file);
            evidenceDataURLs.push(dataUrl);

            const img = document.createElement('img');
            img.src = dataUrl;
            img.alt = file.name;
            img.className = 'w-full h-24 object-cover rounded-md shadow-sm';
            const wrapper = document.createElement('div');
            wrapper.className = 'border rounded-md p-1 bg-gray-50';
            wrapper.appendChild(img);
            preview.appendChild(wrapper);
        }
    });

    function fileToDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (ev) => resolve(ev.target.result);
            reader.onerror = (err) => reject(err);
            reader.readAsDataURL(file);
        });
    }

    // Fun√ß√£o para gerar PDF (agora async porque incorpora imagens)
    async function generatePDF(formData, imageDataUrls = []) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        doc.setFontSize(16);

        // T√çTULO e espa√ßo para logo (se existir)
        const marginLeft = 40;
        let y = 50;
        doc.text('üìå Solicita√ß√£o de Servi√ßo', marginLeft, y);
        y += 20;

        // Detalhes do formul√°rio
        doc.setFontSize(11);
        const add = (label, value) => {
            doc.text(`${label}: ${value}`, marginLeft, y);
            y += 16;
        };

        add("Nome", formData.name);
        add("E-mail", formData.email);
        add("Telefone", formData.phone);
        add("Tipo de Servi√ßo", formData.serviceType);
        add("Urg√™ncia", formData.urgency);
        add("Or√ßamento Previsto", `R$ ${parseFloat(formData.budget || 0).toFixed(2)}`);
        add("Termos Aceitos", formData.terms ? "Sim" : "N√£o");

        y += 6;
        doc.text("Descri√ß√£o:", marginLeft, y);
        y += 14;
        const splitDesc = doc.splitTextToSize(formData.description || '', 500);
        doc.text(splitDesc, marginLeft, y);
        y += (splitDesc.length * 14) + 10;

        // Insere evid√™ncias como imagens no PDF
        if (imageDataUrls && imageDataUrls.length > 0) {
            doc.addPage();
            doc.setFontSize(13);
            doc.text('Evid√™ncias (Fotos):', marginLeft, 50);
            let imgY = 70;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const maxImgWidth = pageWidth - marginLeft * 2;
            const maxImgHeight = (pageHeight - 100) / 2; // 2 imagens por coluna aproximadamente

            for (let i = 0; i < imageDataUrls.length; i++) {
                const dataUrl = imageDataUrls[i];

                // Adiciona nova p√°gina quando necess√°rio
                if (imgY > pageHeight - 120) {
                    doc.addPage();
                    imgY = 60;
                }

                try {
                    // Tentar inserir a imagem (jsPDF suporta JPEG/PNG data URLs)
                    doc.addImage(dataUrl, 'JPEG', marginLeft, imgY, maxImgWidth, maxImgHeight, undefined, 'FAST');
                    imgY += maxImgHeight + 12;
                } catch (err) {
                    // Se falhar por formato, tenta PNG
                    try {
                        doc.addImage(dataUrl, 'PNG', marginLeft, imgY, maxImgWidth, maxImgHeight, undefined, 'FAST');
                        imgY += maxImgHeight + 12;
                    } catch (e) {
                        console.warn('Erro ao adicionar imagem ao PDF', e);
                    }
                }
            }
        }

        // Finaliza retornando Blob
        return doc.output('blob');
    }

    // Fun√ß√£o para enviar para WhatsApp + baixar PDF
    function sendToWhatsApp(formData, pdfBlob) {
        const message = `üìå *Solicita√ß√£o de Servi√ßo*\n\n` +
            `üë§ Nome: ${formData.name}\n` +
            `üìß E-mail: ${formData.email}\n` +
            `üì± Telefone: ${formData.phone}\n` +
            `üõ†Ô∏è Servi√ßo: ${formData.serviceType}\n` +
            `‚ö° Urg√™ncia: ${formData.urgency}\n` +
            `üí∞ Or√ßamento Previsto: R$ ${parseFloat(formData.budget || 0).toFixed(2)}\n` +
            `üìù Descri√ß√£o: ${formData.description}\n` +
            `üñºÔ∏è Evid√™ncias: ${evidenceDataURLs.length} foto(s) anexadas ao PDF\n` +
            `‚úÖ Termos Aceitos: ${formData.terms ? 'Sim' : 'N√£o'}`;

        const encodedMessage = encodeURIComponent(message);
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
            window.open(`whatsapp://send?text=${encodedMessage}`, '_blank');
        } else {
            window.open(`https://web.whatsapp.com/send?text=${encodedMessage}`, '_blank');
        }

        // Baixar PDF automaticamente
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `solicitacao_${formData.name.replace(/\s+/g, '_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Manipular envio do formul√°rio (async para aguardar imagens)
    serviceForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            serviceType: document.getElementById('serviceType').value,
            description: document.getElementById('description').value,
            urgency: document.querySelector('input[name="urgency"]:checked').value,
            budget: document.getElementById('budget').value,
            terms: document.getElementById('terms').checked
        };

        // Gera PDF incorporando as imagens (evidenceDataURLs)
        try {
            const pdfBlob = await generatePDF(formData, evidenceDataURLs);
            sendToWhatsApp(formData, pdfBlob);
        } catch (err) {
            console.error('Erro ao gerar PDF:', err);
            alert('Ocorreu um erro ao gerar a solicita√ß√£o. Tente novamente.');
        }
    });
</script>
</body>
</html>
