<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Solicita√ß√£o - Vers√£o Segura</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* pequeno ajuste para a pr√©via */
    .preview-img { width:100%; height:120px; object-fit:cover; border-radius:6px; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="container max-w-2xl">
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center gap-4 mb-6">
        <!-- Coloque aqui o arquivo da logo (renomeie para logo.jpg) -->
        <img id="systemLogo" src="logo.jpg" alt="Logo" class="w-20 h-20 object-contain rounded-md shadow-sm" onerror="this.style.display='none'">
        <h1 class="text-2xl font-bold">Solicita√ß√£o de Servi√ßo (Privado)</h1>
      </div>

      <form id="serviceForm" class="space-y-4">
        <div>
          <label>Nome</label>
          <input id="name" required class="w-full border p-2 rounded" />
        </div>

        <div>
          <label>E-mail</label>
          <input id="email" type="email" required class="w-full border p-2 rounded" />
        </div>

        <div>
          <label>Telefone</label>
          <input id="phone" required class="w-full border p-2 rounded" />
        </div>

        <div>
          <label>Tipo de Servi√ßo</label>
          <input id="serviceType" list="serviceSuggestions" placeholder="Descreva o tipo de servi√ßo" required class="w-full border p-2 rounded" />
          <datalist id="serviceSuggestions">
            <option value="Higieniza√ß√£o de Estofados"></option>
            <option value="Limpeza de Colch√µes"></option>
            <option value="Reparo de Estofados"></option>
          </datalist>
        </div>

        <div>
          <label>Descri√ß√£o</label>
          <textarea id="description" required class="w-full border p-2 rounded" rows="3"></textarea>
        </div>

        <div>
          <label>Evid√™ncias (fotos) ‚Äî selecione v√°rias</label>
          <input id="images" type="file" accept="image/*" multiple class="block mt-2" />
          <div id="gallery" class="grid grid-cols-3 gap-2 mt-3"></div>
        </div>

        <div class="flex gap-2">
          <button id="submitBtn" type="submit" class="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2">
            <i class="fas fa-paper-plane"></i> Enviar Solicita√ß√£o
          </button>
          <button id="resetBtn" type="button" class="bg-gray-200 px-4 py-2 rounded">Limpar</button>
        </div>

        <div id="linksArea" class="mt-4 text-sm"></div>
      </form>
    </div>
  </div>

<script>
  // CONFIG: ajuste a URL se backend n√£o estiver no mesmo host
  const API_UPLOAD_URL = '/upload'; // Ex.: 'https://meuservidor.com/upload'

  const imagesInput = document.getElementById('images');
  const gallery = document.getElementById('gallery');
  const serviceForm = document.getElementById('serviceForm');
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const linksArea = document.getElementById('linksArea');

  let localFiles = []; // File objects selecionados

  imagesInput.addEventListener('change', (e) => {
    gallery.innerHTML = '';
    localFiles = Array.from(e.target.files).slice(0, 12); // limite 12
    localFiles.forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const url = URL.createObjectURL(file);
      const wrapper = document.createElement('div');
      const img = document.createElement('img');
      img.src = url;
      img.className = 'preview-img';
      wrapper.appendChild(img);
      gallery.appendChild(wrapper);
    });
  });

  resetBtn.addEventListener('click', clearForm);

  function clearForm() {
    serviceForm.reset();
    gallery.innerHTML = '';
    linksArea.innerHTML = '';
    localFiles = [];
    // Limpar input file:
    imagesInput.value = '';
  }

  async function uploadFilesAndGetLinks(formDataObj) {
    // monta FormData
    const fd = new FormData();
    fd.append('name', formDataObj.name);
    fd.append('email', formDataObj.email);
    fd.append('phone', formDataObj.phone);
    fd.append('serviceType', formDataObj.serviceType);
    fd.append('description', formDataObj.description);

    for (let i = 0; i < localFiles.length; i++) {
      fd.append('images', localFiles[i], localFiles[i].name);
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Enviando...';

    try {
      const resp = await fetch(API_UPLOAD_URL, { method: 'POST', body: fd });
      if (!resp.ok) throw new Error('Erro no upload');
      const data = await resp.json();
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicita√ß√£o';
      return data; // { ok, orderId, files: [ {filename, token, url} ] }
    } catch (err) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicita√ß√£o';
      console.error(err);
      throw err;
    }
  }

  function openWhatsAppWithLinks(formObj, fileLinks) {
    // Cria texto com os links (cada link em nova linha)
    let message = `üìå *Solicita√ß√£o de Servi√ßo*\n\n`;
    message += `üë§ Nome: ${formObj.name}\n`;
    message += `üìß E-mail: ${formObj.email}\n`;
    message += `üì± Telefone: ${formObj.phone}\n`;
    message += `üõ†Ô∏è Servi√ßo: ${formObj.serviceType}\n`;
    message += `üìù Descri√ß√£o: ${formObj.description}\n\n`;
    if (fileLinks && fileLinks.length) {
      message += `üì∏ Evid√™ncias (links tempor√°rios):\n`;
      for (const f of fileLinks) {
        message += `${f.url}\n`;
      }
      message += '\n';
    }
    message += '‚úÖ Obrigado.';

    const encoded = encodeURIComponent(message);
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    const url = isMobile ? `whatsapp://send?text=${encoded}` : `https://web.whatsapp.com/send?text=${encoded}`;
    window.open(url, '_blank');
  }

  serviceForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formObj = {
      name: document.getElementById('name').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      serviceType: document.getElementById('serviceType').value.trim(),
      description: document.getElementById('description').value.trim()
    };

    try {
      const result = await uploadFilesAndGetLinks(formObj);
      if (!result || !result.ok) throw new Error('Upload falhou');

      // Exibe links para o usu√°rio copiar/baixar (opcional)
      linksArea.innerHTML = '<strong>Links tempor√°rios das evid√™ncias (compartilhe via WhatsApp):</strong><br/>';
      result.files.forEach(f => {
        const a = document.createElement('a');
        a.href = f.url;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = f.filename + ' ‚Äî abrir/baixar';
        const div = document.createElement('div');
        div.appendChild(a);
        linksArea.appendChild(div);
      });

      // Abre WhatsApp com os links inclu√≠dos na mensagem
      openWhatsAppWithLinks(formObj, result.files);

      // Limpa formul√°rio para novo preenchimento
      clearForm();

    } catch (err) {
      alert('Erro ao enviar solicita√ß√£o. Tente novamente.');
      console.error(err);
    }
  });
</script>
</body>
</html>
